<!doctype html>
  <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html> <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Data portability: Importing feed data into emoncms - Blog | OpenEnergyMonitor</title>
    <meta name="author" content="Glyn Hudson">
    <meta name="description" content="OpenEnergyMonitor Blog">
    
    <meta name="viewport" content="width=device-width">
    <link rel="canonical" href="https://blog.openenergymonitor.org/2012/09/data-portability-importing-feed-data/">

    <meta property="fb:app_id" content="">
    <meta property="og:title" content="Data portability: Importing feed data into emoncms">
    <meta property="og:site_name" content="Blog | OpenEnergyMonitor">
    <meta property="og:url" content="https://blog.openenergymonitor.org/2012/09/data-portability-importing-feed-data/">
    <meta property="og:type" content="article">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@openenergymon">
    
    <meta name="twitter:title" content="Data portability: Importing feed data into emoncms">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet">
    <link href="/atom.xml" rel="alternate" title="Blog | OpenEnergyMonitor" type="application/atom+xml">
    <link rel='shortcut icon' href='/images/favicon.ico' />
    <link rel='icon' type='image/png' href='/images/favicon-192x192.png' sizes='192x192' />
    
    
    
    <link rel="shortcut icon" href="/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="/favicon.ico">
	<link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-192.png">
	<link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png">
	<link rel="icon" type="image/png" sizes="64x64" href="/images/favicon-64.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
	<link rel="apple-touch-icon" href="/images/favicon-57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon-114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon-72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon-144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon-60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon-120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon-76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon-152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-180.png">
	<meta name="msapplication-TileColor" content="#FFFFFF">
	<meta name="msapplication-TileImage" content="/images/favicon-144.png">
	<meta name="msapplication-config" content="/images/browserconfig.xml">
	
  </head>

  <body >

    <header>
      <div class="grid-wrapper">
  <div class="grid">

    <div class="grid__item three-tenths lap-two-sixths palm-one-whole ha-title">
  <a href="/" class="site-title">
    <!--<img width='40' src='/images/favicon-192x192.png'> -->
    
    <span style="color:#555;font-weight:bold;font-family:Arial;font-size:20"'>
Open</span><span style="color:#0699fa;font-weight:bold;font-family:Arial;font-size:20"'>EnergyMonitor</span>

  </a>
</div>

<div class="grid__item seven-tenths lap-four-sixths palm-one-whole">
  <nav>
    <input type="checkbox" id="toggle">
<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
<ul class="menu pull-right">
  <li><a href="https://openenergymonitor.org">Main Site</a></li>
  <li><a href="https://guide.openenergymonitor.org">User Guide</a></li>
  <li><a href="https://emoncms.org">Emoncms</a></li>
  <li><a href="https://community.openenergymonitor.org">Community</a></li>
  <li><a href="https://shop.openenergymonitor.com    ">Shop<i class="icon icon-shopping-cart"></i></a></li>
</ul>
  </nav>
</div>

  </div>
</div>
    </header>

    

    <div class="grid-wrapper">
      <div class="grid grid-center">
        
        <div class="grid__item two-thirds lap-one-whole palm-one-whole">
        

          <article class="post">
  <div class='edit-github'><a href='https://github.com/openenergymonitor/blog/tree/master/source/_posts/2012-09-21-data-portability-importing-feed-data.html'>Edit on GitHub</a></div>
<div class='edit-github'><a href='http://prose.io/#openenergymonitor/blog/edit/master/source/_posts/2012-09-21-data-portability-importing-feed-data.html'>Edit on GitHub Prose</a></div>
  
  <header>
  
  <h1 class="title indent">Data portability: Importing feed data into emoncms</h1>
  

  
  <div class="meta clearfix">
    <time datetime="2012-09-21T10:57:00+00:00" pubdate data-updated="true"><i class="icon-calendar"></i> 2012-09-21 10:57:00 +00002012-09-21 10:57:00 +0000
    <span class="byline author vcard"><i class='icon-user'></i> Trystan Lea</span> <br>
    <span><i class='icon-time'></i> eight minutes reading time</span> <br>
    <span>
    <i class="icon-tags"></i>
    <ul class="tags unstyled">
    
      
        <li><a class='category' href='/categories/emoncms/'>emoncms</a></li>
      
    
    </ul>
  </span> <br>
    
      <a class='comments'
         href="/2012/09/data-portability-importing-feed-data/#disqus_thread"
         >Comments</a>
    
  </div>
  
</header>


  The<a href="http://openenergymonitor.blogspot.co.uk/2012/09/data-portability-exporting-feed-data.html"> last post</a> detailed an implementation for exporting feed data from emoncms, this post explores an implementation for importing feed data, which can be used in conjunction with the export implementation to sync or download feed data from one emoncms instance to another enabling full feed data portability.<br /><br />I started by trying to create an import script that was build into a normal page action, you would go to a page ie:<br /><br /><i>sync/feed?id=10...</i><br /><br />The problem with this is that downloading and importing a feed takes a long time and so the page will appear unresponsive for that time, the loading animation just turns and turns. <br /><br />If you mistakenly click on the refresh button, the initial process will not close and so you will start to get duplicate processes which will mess up the data and increase the server load.<br /><br />Ideally while downloading and importing the data there would be a progress bar so that you can see what's happening and any other useful feedback if things go wrong.<br /><br />To get this kind of feedback you need to be able to update the browser as the process is running.<br /><br />You also want the syncing to happen directly between servers rather than server to local computer to server as this would be faster in instances where both servers are remote and the internet access to the local computer is relatively slow, - i.e you want the import process handled in php which is server side (you could use another server side language if you wanted).<br /><br />The way to get feedback about what's happening while having the import process being handled in php is to have two separate scripts one that handles the importing and another that can be refreshed regularly serves the gui webpage.<br /><br />We can extend the idea of a separate import script to sort the problem of duplicate processes too by implementing a download and import queue.<br /><br />When a user clicks to download/sync a feed in the sync page, the action behind this enters the details of the feed to be downloaded in the queue, it can also check at this point that it does not already exist in the queue.<br /><br />We can then run the import script independently of the gui page, such as via a scheduled cron job that runs the script one a minute. We can put a check in there to ensure that only one instance of the script is running at any given time too.<br /><br />The import script then checks if there are feeds to be downloaded in the import queue, working through each queue item sequentially.<br /><br />The added advantage of the queue implementation is that we can keep the load that importing places on the server low allowing only one feed to be downloaded and imported at any given time.<br /><br />So all in all this implementation:<br /><ul><li>Enables feedback on import progress.</li><li>Ensures we donâ€™t get duplicate feed syncing processes.</li><li>Ensures that the server load is kept under control.</li></ul><div>On to the code, here's the import script that works through the import queue and downloads and imports each item sequentially, I would be interested to hear if there are any ways the efficiency of the export and import process can be improved.</div><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; background: white; border-width: .1em .1em .1em .8em; border: solid gray; color: black; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #bc7a00;">&lt;?php</span><br /><br />  <span style="color: #408080; font-style: italic;">// Ensure only one instance of the script can run at any one time.</span><br />  <span style="color: #19177c;">$fp</span> <span style="color: #666666;">=</span> <span style="color: green;">fopen</span>(<span style="color: #ba2121;">"importlock"</span>, <span style="color: #ba2121;">"w"</span>);<br />  <span style="color: green; font-weight: bold;">if</span> (<span style="color: #666666;">!</span> <span style="color: green;">flock</span>(<span style="color: #19177c;">$fp</span>, LOCK_EX <span style="color: #666666;">|</span> LOCK_NB)) { <span style="color: green; font-weight: bold;">echo</span> <span style="color: #ba2121;">"Already running</span><span style="color: #bb6622; font-weight: bold;">\n</span><span style="color: #ba2121;">"</span>; <span style="color: green; font-weight: bold;">die</span>; }<br /><br />  <span style="color: #408080; font-style: italic;">// Connect to the database</span><br />  <span style="color: green;">define</span>(<span style="color: #ba2121;">'EMONCMS_EXEC'</span>, <span style="color: #666666;">1</span>);<br />  <span style="color: green; font-weight: bold;">require</span> <span style="color: #ba2121;">"Includes/process_settings.php"</span>;<br />  <span style="color: green; font-weight: bold;">require</span> <span style="color: #ba2121;">"Includes/db.php"</span>;<br />  <span style="color: green; font-weight: bold;">switch</span>(db_connect()) {<br />    <span style="color: green; font-weight: bold;">case</span> <span style="color: #666666;">0:</span> <span style="color: green; font-weight: bold;">break</span>;<br />    <span style="color: green; font-weight: bold;">case</span> <span style="color: #666666;">1:</span> <span style="color: green; font-weight: bold;">break</span>;  <br />    <span style="color: green; font-weight: bold;">case</span> <span style="color: #666666;">3:</span> show_dbsettingserror_message(); <span style="color: green; font-weight: bold;">die</span> ;<br />  }<br /><br />  <span style="color: #408080; font-style: italic;">// Fetch the import queue</span><br />  <span style="color: #19177c;">$result</span> <span style="color: #666666;">=</span> db_query(<span style="color: #ba2121;">"SELECT * FROM importqueue ORDER BY `queid` Asc"</span>);<br /><br />  <span style="color: #408080; font-style: italic;">// For each item in the queue</span><br />  <span style="color: green; font-weight: bold;">while</span>(<span style="color: #19177c;">$row</span> <span style="color: #666666;">=</span> db_fetch_array(<span style="color: #19177c;">$result</span>))<br />  {<br />    <span style="color: #19177c;">$queid</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'queid'</span>];<br />    <span style="color: #19177c;">$feedname</span> <span style="color: #666666;">=</span> <span style="color: #ba2121;">"feed_"</span><span style="color: #666666;">.</span>trim(<span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'localfeedid'</span>])<span style="color: #666666;">.</span><span style="color: #ba2121;">""</span>;<br /><br />    <span style="color: #408080; font-style: italic;">// Check if we have already downloaded part of the feed and get the last </span><br />    <span style="color: #408080; font-style: italic;">// value entered so that we dont download and insert data that has already </span><br />    <span style="color: #408080; font-style: italic;">// been inserted this makes this utility useful for syncing in general </span><br />    <span style="color: #408080; font-style: italic;">// and in particlar backup that only downloads the latest changes. </span><br />    <span style="color: #19177c;">$feed_result</span> <span style="color: #666666;">=</span> db_query(<span style="color: #ba2121;">"SELECT * FROM </span><span style="color: #bb6688; font-weight: bold;">$feedname</span><span style="color: #ba2121;"> ORDER BY time Desc LIMIT 1"</span>);<br />    <span style="color: #19177c;">$feed_row</span> <span style="color: #666666;">=</span> db_fetch_array(<span style="color: #19177c;">$feed_result</span>);<br />    <span style="color: #19177c;">$start</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span>; <span style="color: green; font-weight: bold;">if</span> (<span style="color: #19177c;">$feed_row</span>[<span style="color: #666666;">0</span>]) <span style="color: #19177c;">$start</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$feed_row</span>[<span style="color: #666666;">0</span>];<br /><br />    <span style="color: #408080; font-style: italic;">// Open the file served from the export page on the remote server</span><br />    <span style="color: #19177c;">$url</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'baseurl'</span>]<span style="color: #666666;">.</span><span style="color: #ba2121;">'/feed/export?apikey='</span><span style="color: #666666;">.</span><span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'apikey'</span>]<span style="color: #666666;">.</span><span style="color: #ba2121;">'&amp;id='</span><br />    <span style="color: #666666;">.</span><span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'feedid'</span>]<span style="color: #666666;">.</span><span style="color: #ba2121;">'&amp;start='</span><span style="color: #666666;">.</span><span style="color: #19177c;">$start</span>;<br /><br />    <span style="color: green; font-weight: bold;">echo</span> <span style="color: #ba2121;">"Opening file </span><span style="color: #bb6688; font-weight: bold;">$url</span><span style="color: #bb6622; font-weight: bold;">\n</span><span style="color: #ba2121;">"</span>;<br />    <span style="color: #19177c;">$fh</span> <span style="color: #666666;">=</span> <span style="color: #666666;">@</span><span style="color: green;">fopen</span>( <span style="color: #19177c;">$url</span>, <span style="color: #ba2121;">'r'</span> );<br /> <br />    <span style="color: #408080; font-style: italic;">// Read through the file</span><br />    <span style="color: #19177c;">$i</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span>;<br />    <span style="color: green; font-weight: bold;">while</span> ((<span style="color: #19177c;">$data</span> <span style="color: #666666;">=</span> <span style="color: green;">fgetcsv</span>(<span style="color: #19177c;">$fh</span>, <span style="color: #666666;">0</span>, <span style="color: #ba2121;">","</span>)) <span style="color: #666666;">!==</span> <span style="color: green; font-weight: bold;">FALSE</span>) <br />    {<br />      <span style="color: #19177c;">$feedtime</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$data</span>[<span style="color: #666666;">0</span>]; <span style="color: #19177c;">$value</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$data</span>[<span style="color: #666666;">1</span>];<br /><br />      <span style="color: green; font-weight: bold;">if</span> (<span style="color: #19177c;">$feedtime</span><span style="color: #666666;">!=</span><span style="color: #ba2121;">''</span> <span style="color: #666666;">&amp;&amp;</span> <span style="color: #19177c;">$value</span><span style="color: #666666;">!=</span><span style="color: #ba2121;">''</span>)<br />      {<br />        <span style="color: #19177c;">$i</span><span style="color: #666666;">++</span>;<br />        <span style="color: #408080; font-style: italic;">//Contruct values part of the query</span><br />        <span style="color: green; font-weight: bold;">if</span> (<span style="color: #19177c;">$i</span><span style="color: #666666;">!=1</span>) <span style="color: #19177c;">$vals</span> <span style="color: #666666;">.=</span> <span style="color: #ba2121;">','</span>;<br />        <span style="color: #19177c;">$vals</span> <span style="color: #666666;">.=</span> <span style="color: #ba2121;">"('</span><span style="color: #bb6688; font-weight: bold;">$feedtime</span><span style="color: #ba2121;">','</span><span style="color: #bb6688; font-weight: bold;">$value</span><span style="color: #ba2121;">')"</span>;<br /><br />        <span style="color: #408080; font-style: italic;">// Execute query every 400 rows (same block size as export script)</span><br />        <span style="color: green; font-weight: bold;">if</span> (<span style="color: #19177c;">$i</span><span style="color: #666666;">&gt;400</span>)<br />        {<br />          <span style="color: #19177c;">$i</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span>;<br />          <span style="color: green; font-weight: bold;">if</span> (<span style="color: #19177c;">$vals</span>) db_query(<span style="color: #ba2121;">"INSERT INTO </span><span style="color: #bb6688; font-weight: bold;">$feedname</span><span style="color: #ba2121;"> (`time`,`data`) VALUES "</span><span style="color: #666666;">.</span><span style="color: #19177c;">$vals</span>);<br />          <span style="color: #19177c;">$vals</span> <span style="color: #666666;">=</span> <span style="color: #ba2121;">""</span>;<br />        }<br />      }<br />    }<br />    <span style="color: #408080; font-style: italic;">// If there are lines to be inserted left over insert them here at the end</span><br />    <span style="color: green; font-weight: bold;">if</span> (<span style="color: #19177c;">$vals</span>) db_query(<span style="color: #ba2121;">"INSERT INTO </span><span style="color: #bb6688; font-weight: bold;">$feedname</span><span style="color: #ba2121;"> (`time`,`data`) VALUES "</span><span style="color: #666666;">.</span><span style="color: #19177c;">$vals</span>);    <br /><br />    <span style="color: green;">fclose</span>(<span style="color: #19177c;">$fh</span>);<br /><br />    <span style="color: green; font-weight: bold;">echo</span> <span style="color: #ba2121;">"Transfer complete</span><span style="color: #bb6622; font-weight: bold;">\n</span><span style="color: #ba2121;">"</span>;<br />    <span style="color: green; font-weight: bold;">echo</span> <span style="color: #ba2121;">"Deleting item </span><span style="color: #bb6688; font-weight: bold;">$queid</span><span style="color: #ba2121;"> from queue</span><span style="color: #bb6622; font-weight: bold;">\n</span><span style="color: #ba2121;">"</span>;<br />    db_query(<span style="color: #ba2121;">"DELETE FROM importqueue WHERE queid = </span><span style="color: #bb6688; font-weight: bold;">$queid</span><span style="color: #ba2121;">"</span>);<br />  }<br /><br /><span style="color: #bc7a00;">?&gt;</span><br /></pre></div><br />In the next post I will explain the interface for generating the feed import queue.
      <b>To engage in discussion regarding this post, please post on our <a href="http://community.openenergymonitor.org">Community Forum</a></b>.
    <br>
</article>



        </div>

        
        <aside id="sidebar" class="grid__item one-third lap-one-whole palm-one-whole">
          <div class="grid">

 
 <section id="recent-posts" class="aside-module grid__item one-whole lap-one-half">
  <h1 class="title delta">Recent Posts</h1>
  <ul class="divided">
    
      
        <li class="post">
          <a href="/2016/06/esp8266-ota-update/">Part 3/3: Continuous Deployment (Over-The-Air Update to ESP8266)</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/emoncms-docker/">Emoncms Docker</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/esp8266-emonesp-developments/">ESP8266 WIFI developments</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/auto-build-continuous-test-firmware/">Part 2/3: Firmware Continuous Test & Build</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/platformio/">Part 1/3: PlatformIO open-source embedded development ecosystem</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/06/emonpi-vrms-line-fault/">Electrical Supply Line Vault</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/emonsd-update-03may16/">Substantial update to emonPi / emonBase: emonSD-03-May16 pre-built image release</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/emonpi-raspberrypi3/">emonPi / emonBase Raspberry Pi 3</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/emoncms-qr/">Emoncms android App QR Code Scanner Setup</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/website-changes/">New Forum, Blog and User Guide Website</a>
        </li>
      
    
  </ul>
</section>
  
  
</div>
        </aside>
        
      </div>
    </div>

    <footer>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item">
      <style>


div.searchtool {
  position: relative;
  display: inline-block;
  top: -6px;
}

input[type=text] {
  border: 3px solid #0699fa;
}

fieldset {
  border: 0;
}

</style>
<div class="copyright">

  <a rel="me" href='https://twitter.com/openenergymon'><i class="icon-twitter"></i></a>
  <a rel="me" href='https://github.com/openenergymonitor/guide'><i class="icon-github"></i></a>
  <a rel="me" href='https://blog.openenergymonitor.org/feed.xml'><i class="icon-rss"></i></a>

  <div class="credit">
    Website powered by <a href='http://jekyllrb.com/'>Jekyll</a> and <a href='https://github.com/coogie/oscailte'>Oscalite</a>.<br />
    Hosted by <a href='https://pages.github.com/'>GitHub</a> and served by <a href='https://cloudflare.com'>CloudFlare</a>.
  </div>

<div class="searchtool">


<form action="https://encrypted.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.openenergymonitor.org" />
    <input class="search" id="search" type="text" name="q" results="0" placeholder="Search..." />
  </fieldset>
</form>


</div>
</div>
    </div>
  </div>
</div>
    </footer>

    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <script>
  var _gaq=[['_setAccount','UA-10321170-4'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
<script>
  var disqus_shortname = 'openenergymonitor';
  
    
    var disqus_script = 'count.js';
  
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


<script>
  $(document).ready(function(){
    if (!window.jXHR){
      var jxhr = document.createElement('script');
      jxhr.type = 'text/javascript';
      jxhr.src = '/javascripts/libs/jXHR.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jxhr, s);
    }

    github.showRepos({
      user: 'openenergymonitor',
      count: 5,
      skip_forks: true,
      target: '#gh_repos'
    });
  });
</script>
<script src="/javascripts/github.js"></script>

  </body>
</html>