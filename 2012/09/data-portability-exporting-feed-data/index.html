<!doctype html>
  <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html> <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Data portability: exporting feed data from emoncms - Blog | OpenEnergyMonitor</title>
    <meta name="author" content="Glyn Hudson">
    <meta name="description" content="OpenEnergyMonitor Blog">
    
    <meta name="viewport" content="width=device-width">
    <link rel="canonical" href="http://blog.openenergymonitor.org/2012/09/data-portability-exporting-feed-data/">

    <meta property="fb:app_id" content="">
    <meta property="og:title" content="Data portability: exporting feed data from emoncms">
    <meta property="og:site_name" content="Blog | OpenEnergyMonitor">
    <meta property="og:url" content="http://blog.openenergymonitor.org/2012/09/data-portability-exporting-feed-data/">
    <meta property="og:type" content="article">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@openenergymon">
    
    <meta name="twitter:title" content="Data portability: exporting feed data from emoncms">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet">
    <link href="/atom.xml" rel="alternate" title="Blog | OpenEnergyMonitor" type="application/atom+xml">
    <link rel='shortcut icon' href='/images/favicon.ico' />
    <link rel='icon' type='image/png' href='/images/favicon-192x192.png' sizes='192x192' />
    
    
    
    <link rel="shortcut icon" href="/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="/favicon.ico">
	<link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-192.png">
	<link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png">
	<link rel="icon" type="image/png" sizes="64x64" href="/images/favicon-64.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
	<link rel="apple-touch-icon" href="/images/favicon-57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon-114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon-72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon-144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon-60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon-120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon-76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon-152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-180.png">
	<meta name="msapplication-TileColor" content="#FFFFFF">
	<meta name="msapplication-TileImage" content="/images/favicon-144.png">
	<meta name="msapplication-config" content="/images/browserconfig.xml">
	
  </head>

  <body >

    <header>
      <div class="grid-wrapper">
  <div class="grid">

    <div class="grid__item three-tenths lap-two-sixths palm-one-whole ha-title">
  <a href="/" class="site-title">
    <!--<img width='40' src='/images/favicon-192x192.png'> -->
    
    <span style="color:#555;font-weight:bold;font-family:Arial;font-size:20"'>
Open</span><span style="color:#0699fa;font-weight:bold;font-family:Arial;font-size:20"'>EnergyMonitor</span>

  </a>
</div>

<div class="grid__item seven-tenths lap-four-sixths palm-one-whole">
  <nav>
    <input type="checkbox" id="toggle">
<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
<ul class="menu pull-right">
  <li><a href="http://openenergymonitor.org">Home</a></li>
  <li><a href="http://shop.openenergymonitor.com">Online-Store</a></li>
  <li><a href="http://guide.openenergymonitor.org">User Guide</a></li>
  <li><a href="http://emoncms.org">Emoncms</a></li>
  <li><a href="http://community.openenergymonitor.org">Forum</a></li>
</ul>
  </nav>
</div>

  </div>
</div>
    </header>

    

    <div class="grid-wrapper">
      <div class="grid grid-center">
        
        <div class="grid__item two-thirds lap-one-whole palm-one-whole">
        

          <article class="post">
  <div class='edit-github'><a href='https://github.com/openenergymonitor/blog/tree/master/source/_posts/2012-09-19-data-portability-exporting-feed-data.html'>Edit this post on GitHub</a></div>
  
  <header>
  
  <h1 class="title indent">Data portability: exporting feed data from emoncms</h1>
  

  
  <div class="meta clearfix">
    <time datetime="2012-09-19T21:26:00+00:00" pubdate data-updated="true"><i class="icon-calendar"></i> 2012-09-19 21:26:00 +00002012-09-19 21:26:00 +0000
    <span class="byline author vcard"><i class='icon-user'></i> Trystan Lea</span> <br>
    <span><i class='icon-time'></i> four minutes reading time</span> <br>
    <span>
    <i class="icon-tags"></i>
    <ul class="tags unstyled">
    
      
        <li><a class='category' href='/categories/emoncms/'>emoncms</a></li>
      
    
    </ul>
  </span> <br>
    
      <a class='comments'
         href="/2012/09/data-portability-exporting-feed-data/#disqus_thread"
         >Comments</a>
    
  </div>
  
</header>


  Following on from the previous two posts:<br /><a href="http://openenergymonitor.blogspot.com/2012/09/making-emoncms-data-portable.html">Making emoncms data portable</a><br /><a href="http://openenergymonitor.blogspot.com/2012/09/data-portability-challenges.html">Data portability challenges</a><br /><br />Here's my initial solution for feed export code that also&nbsp;allows&nbsp;it's load on the server to be regulated.<br /><br />In trying to work this out I first tired requesting all the feed data (which could be millions of rows) in one mysql query and then writing the data to a file in one push, Testing on my laptop server installation and monitoring the load with the linux top tool the mysql query can use around 97% of the cpu for up to tens of seconds depending on the feed size. Once the query is complete the writing of the file (an apache process) then takes up another block of 97% cpu use until the file has completed downloading. Emoncms still seems fairly responsive in that time.<br /><br />My next thought was to break up that larger query into smaller blocks and introducing a delay between the reading of each block, maybe the delay could wait for other actions to finish before continuing in future versions.<br /><br />Spiting&nbsp;the query into blocks of 400 rows,&nbsp;alternately&nbsp;loading and writing to the file without a delay drops the load to around 50% for both the mysql and apache processes.<br /><br />By introducing a delay of about 80 microseconds its then possible to drop the load down to roughly 10% for the apache process and a little less for the mysql process.<br /><br />Increasing the block size or/and reducing the delay speeds the transfer rate up, reducing the block size or/and increasing the delay slows the transfer rate down.<br /><br />Any thoughts on improving this would be welcome, I will try and add it to the emoncms repo soon.<br /><br />Here's the code:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; background: white; border-width: .1em .1em .1em .8em; border: solid gray; color: black; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #bc7a00;">&lt;?php</span><br /><span class="Apple-style-span" style="font-family: 'Times New Roman'; line-height: normal; white-space: normal;"><pre style="line-height: 16px;">  <span style="color: #408080; font-style: italic;">// Open database etc here</span></pre></span><span class="Apple-style-span" style="font-family: 'Times New Roman'; line-height: normal; white-space: normal;"><pre style="line-height: 16px;">  <span style="color: #408080; font-style: italic;">// Extend timeout limit from 30s to 2mins</span></pre></span><span class="Apple-style-span">  <span style="color: green;">set_time_limit</span> (<span style="color: #666666;">120</span>);    <span style="color: #408080; font-style: italic;">// Feed id and start time of feed to export</span>  <span style="color: #19177c;">$feedid</span> <span style="color: #666666;">=</span> <span style="color: #666666;">1</span></span>;<span class="Apple-style-span">  <span style="color: #19177c;">$start</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span></span>;<span class="Apple-style-span">     <span style="color: #408080; font-style: italic;">// Regulate mysql and apache load.</span>  <span style="color: #19177c;">$block_size</span> <span style="color: #666666;">=</span> <span style="color: #666666;">400</span>;   <span style="color: #19177c;">$sleep</span> <span style="color: #666666;">=</span> <span style="color: #666666;">80000</span>;    <span style="color: #19177c;">$feedname</span> <span style="color: #666666;">=</span> <span style="color: #ba2121;">"feed_"</span><span style="color: #666666;">.</span>trim(<span style="color: #19177c;">$feedid</span>)<span style="color: #666666;">.</span><span style="color: #ba2121;">""</span>;   <span style="color: #19177c;">$fileName</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$feedname</span><span style="color: #666666;">.</span><span style="color: #ba2121;">'.csv'</span>;     <span style="color: #408080; font-style: italic;">// There is no need for the browser to cache the output</span>  header(<span style="color: #ba2121;">"Cache-Control: no-cache, no-store, must-revalidate"</span>);    <span style="color: #408080; font-style: italic;">// Tell the browser to handle output as a csv file to be downloaded</span>  header(<span style="color: #ba2121;">'Content-Description: File Transfer'</span>);   header(<span style="color: #ba2121;">"Content-type: text/csv"</span>);   header(<span style="color: #ba2121;">"Content-Disposition: attachment; filename=</span><span style="color: #bb6688; font-weight: bold;">{</span><span style="color: #19177c;">$fileName</span><span style="color: #bb6688; font-weight: bold;">}</span><span style="color: #ba2121;">"</span>);    header(<span style="color: #ba2121;">"Expires: 0"</span>);   header(<span style="color: #ba2121;">"Pragma: no-cache"</span>);    <span style="color: #408080; font-style: italic;">// Write to output stream</span>  <span style="color: #19177c;">$fh</span> <span style="color: #666666;">=</span> <span style="color: #666666;">@</span><span style="color: green;">fopen</span>( <span style="color: #ba2121;">'php://output'</span>, <span style="color: #ba2121;">'w'</span> );    <span style="color: #408080; font-style: italic;">// Load new feed blocks until there is no more data </span>  <span style="color: #19177c;">$moredata_available</span> <span style="color: #666666;">=</span> <span style="color: #666666;">1</span>;   <span style="color: green; font-weight: bold;">while</span> (<span style="color: #19177c;">$moredata_available</span>)   {     <span style="color: #408080; font-style: italic;">// 1) Load a block</span>    <span style="color: #19177c;">$result</span> <span style="color: #666666;">=</span> db_query(<span style="color: #ba2121;">"SELECT * FROM </span><span style="color: #bb6688; font-weight: bold;">$feedname</span><span style="color: #ba2121;"> WHERE time&gt;</span><span style="color: #bb6688; font-weight: bold;">$start</span><span style="color: #ba2121;"> &nbsp;</span></span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #ba2121;">    ORDER BY time Asc Limit </span><span style="color: #bb6688; font-weight: bold;">$block_size</span><span style="color: #ba2121;">"</span>);<br /><br />    <span style="color: #19177c;">$moredata_available</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span>;<br />    <span style="color: green; font-weight: bold;">while</span>(<span style="color: #19177c;">$row</span> <span style="color: #666666;">=</span> db_fetch_array(<span style="color: #19177c;">$result</span>)) {<br /><br />      <span style="color: #408080; font-style: italic;">// Write block as csv to output stream</span><br />      <span style="color: green;">fputcsv</span>(<span style="color: #19177c;">$fh</span>, <span style="color: green; font-weight: bold;">array</span>(<span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'time'</span>],<span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'data'</span>]));<br /><br />      <span style="color: #408080; font-style: italic;">// Set new start time so that we read the next block along</span><br />      <span style="color: #19177c;">$start</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'time'</span>];<br />      <span style="color: #19177c;">$moredata_available</span> <span style="color: #666666;">=</span> <span style="color: #666666;">1</span>;<br />    }<br />    <span style="color: #408080; font-style: italic;">// 2) Sleep for a bit</span><br />    <span style="color: green;">usleep</span>(<span style="color: #19177c;">$sleep</span>);<br />  }<br /><br />  <span style="color: green;">fclose</span>(<span style="color: #19177c;">$fh</span>);<br /></pre></div><br />In the next post I will discuss creating a script to import feed data by pointing directly at the export script on the other server, plus a background running&nbsp;daemon&nbsp;process and queueing&nbsp;mechanism&nbsp;to manage the import process.
      <b>To engage in discussion regarding this post, please post on our <a href="http://community.openenergymonitor.org">Community Forum</a></b>.
    <br>
</article>



        </div>

        
        <aside id="sidebar" class="grid__item one-third lap-one-whole palm-one-whole">
          <div class="grid">

 
 <section id="recent-posts" class="aside-module grid__item one-whole lap-one-half">
  <h1 class="title delta">Recent Posts</h1>
  <ul class="divided">
    
      
        <li class="post">
          <a href="/2016/05/website-changes/">New Forum, Blog and User Guide Website</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/Part3-Aggregated-supply-and-demand/">Part 3: Aggregated supply and demand across multiple households</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Part2-Exploring-carbon-intensity/">Part 2: Exploring carbon intensity and renewable energy matching</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Understand-CO2-intensity-grid-electricity/">Part 1: Attempting to measure and understand the CO2 intensity of grid electricity</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Git-Sub-Modules/">GitHub Submodules</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Home-Assistant/">Home Assistant and emonPi</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/03/raspberry-pi-3/">Raspberry Pi 3 </a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/02/outdoor-temperature-data-from-weather/">Outdoor Temperature Data from Weather Underground to Emoncms & MQTT</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/02/heat-pump-testing-initial-results/">Heat pump Testing: Initial results</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/01/french-low-carbon-energy-film-featuring/">Low carbon energy film featuring OpenEnergyMonitor</a>
        </li>
      
    
  </ul>
</section>
  
  
</div>
        </aside>
        
      </div>
    </div>

    <footer>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item">
      <div class="copyright">
  <a rel="me" href='https://twitter.com/openenergymon'><i class="icon-twitter"></i></a>
  <a rel="me" href='https://github.com/openenergymonitor'><i class="icon-github"></i></a>
  <a rel="me" href='http://blog.openenergymonitor.org/atom.xml'><i class="icon-rss"></i></a>

  <div class="credit">
    Website powered by <a href='http://jekyllrb.com/'>Jekyll</a> and the <a href='https://github.com/coogie/oscailte'>Oscalite theme</a>.<br />
    Hosted by <a href='https://pages.github.com/'>GitHub</a> and served by <a href='https://cloudflare.com'>CloudFlare</a>.
  </div>
</div>
    </div>
  </div>
</div>
    </footer>

    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <script>
  var _gaq=[['_setAccount','UA-10321170-4'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
<script>
  var disqus_shortname = 'openenergymonitor';
  
    
    var disqus_script = 'count.js';
  
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


<script>
  $(document).ready(function(){
    if (!window.jXHR){
      var jxhr = document.createElement('script');
      jxhr.type = 'text/javascript';
      jxhr.src = '/javascripts/libs/jXHR.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jxhr, s);
    }

    github.showRepos({
      user: 'openenergymonitor',
      count: 5,
      skip_forks: true,
      target: '#gh_repos'
    });
  });
</script>
<script src="/javascripts/github.js"></script>

  </body>
</html>