---
layout: post
title: 'Data portability: exporting feed data from emoncms'
date: '2012-09-19T14:26:00.004-07:00'
author: Trystan Lea
categories:
- emoncms
modified_time: '2012-09-27T04:13:48.429-07:00'
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-8096754141358012240
blogger_orig_url: http://openenergymonitor.blogspot.com/2012/09/data-portability-exporting-feed-data.html
---

Following on from the previous two posts:<br /><a href="http://openenergymonitor.blogspot.com/2012/09/making-emoncms-data-portable.html">Making emoncms data portable</a><br /><a href="http://openenergymonitor.blogspot.com/2012/09/data-portability-challenges.html">Data portability challenges</a><br /><br />Here's my initial solution for feed export code that also&nbsp;allows&nbsp;it's load on the server to be regulated.<br /><br />In trying to work this out I first tired requesting all the feed data (which could be millions of rows) in one mysql query and then writing the data to a file in one push, Testing on my laptop server installation and monitoring the load with the linux top tool the mysql query can use around 97% of the cpu for up to tens of seconds depending on the feed size. Once the query is complete the writing of the file (an apache process) then takes up another block of 97% cpu use until the file has completed downloading. Emoncms still seems fairly responsive in that time.<br /><br />My next thought was to break up that larger query into smaller blocks and introducing a delay between the reading of each block, maybe the delay could wait for other actions to finish before continuing in future versions.<br /><br />Spiting&nbsp;the query into blocks of 400 rows,&nbsp;alternately&nbsp;loading and writing to the file without a delay drops the load to around 50% for both the mysql and apache processes.<br /><br />By introducing a delay of about 80 microseconds its then possible to drop the load down to roughly 10% for the apache process and a little less for the mysql process.<br /><br />Increasing the block size or/and reducing the delay speeds the transfer rate up, reducing the block size or/and increasing the delay slows the transfer rate down.<br /><br />Any thoughts on improving this would be welcome, I will try and add it to the emoncms repo soon.<br /><br />Here's the code:<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; background: white; border-width: .1em .1em .1em .8em; border: solid gray; color: black; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #bc7a00;">&lt;?php</span><br /><span class="Apple-style-span" style="font-family: 'Times New Roman'; line-height: normal; white-space: normal;"><pre style="line-height: 16px;">  <span style="color: #408080; font-style: italic;">// Open database etc here</span></pre></span><span class="Apple-style-span" style="font-family: 'Times New Roman'; line-height: normal; white-space: normal;"><pre style="line-height: 16px;">  <span style="color: #408080; font-style: italic;">// Extend timeout limit from 30s to 2mins</span></pre></span><span class="Apple-style-span">  <span style="color: green;">set_time_limit</span> (<span style="color: #666666;">120</span>);    <span style="color: #408080; font-style: italic;">// Feed id and start time of feed to export</span>  <span style="color: #19177c;">$feedid</span> <span style="color: #666666;">=</span> <span style="color: #666666;">1</span></span>;<span class="Apple-style-span">  <span style="color: #19177c;">$start</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span></span>;<span class="Apple-style-span">     <span style="color: #408080; font-style: italic;">// Regulate mysql and apache load.</span>  <span style="color: #19177c;">$block_size</span> <span style="color: #666666;">=</span> <span style="color: #666666;">400</span>;   <span style="color: #19177c;">$sleep</span> <span style="color: #666666;">=</span> <span style="color: #666666;">80000</span>;    <span style="color: #19177c;">$feedname</span> <span style="color: #666666;">=</span> <span style="color: #ba2121;">"feed_"</span><span style="color: #666666;">.</span>trim(<span style="color: #19177c;">$feedid</span>)<span style="color: #666666;">.</span><span style="color: #ba2121;">""</span>;   <span style="color: #19177c;">$fileName</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$feedname</span><span style="color: #666666;">.</span><span style="color: #ba2121;">'.csv'</span>;     <span style="color: #408080; font-style: italic;">// There is no need for the browser to cache the output</span>  header(<span style="color: #ba2121;">"Cache-Control: no-cache, no-store, must-revalidate"</span>);    <span style="color: #408080; font-style: italic;">// Tell the browser to handle output as a csv file to be downloaded</span>  header(<span style="color: #ba2121;">'Content-Description: File Transfer'</span>);   header(<span style="color: #ba2121;">"Content-type: text/csv"</span>);   header(<span style="color: #ba2121;">"Content-Disposition: attachment; filename=</span><span style="color: #bb6688; font-weight: bold;">{</span><span style="color: #19177c;">$fileName</span><span style="color: #bb6688; font-weight: bold;">}</span><span style="color: #ba2121;">"</span>);    header(<span style="color: #ba2121;">"Expires: 0"</span>);   header(<span style="color: #ba2121;">"Pragma: no-cache"</span>);    <span style="color: #408080; font-style: italic;">// Write to output stream</span>  <span style="color: #19177c;">$fh</span> <span style="color: #666666;">=</span> <span style="color: #666666;">@</span><span style="color: green;">fopen</span>( <span style="color: #ba2121;">'php://output'</span>, <span style="color: #ba2121;">'w'</span> );    <span style="color: #408080; font-style: italic;">// Load new feed blocks until there is no more data </span>  <span style="color: #19177c;">$moredata_available</span> <span style="color: #666666;">=</span> <span style="color: #666666;">1</span>;   <span style="color: green; font-weight: bold;">while</span> (<span style="color: #19177c;">$moredata_available</span>)   {     <span style="color: #408080; font-style: italic;">// 1) Load a block</span>    <span style="color: #19177c;">$result</span> <span style="color: #666666;">=</span> db_query(<span style="color: #ba2121;">"SELECT * FROM </span><span style="color: #bb6688; font-weight: bold;">$feedname</span><span style="color: #ba2121;"> WHERE time&gt;</span><span style="color: #bb6688; font-weight: bold;">$start</span><span style="color: #ba2121;"> &nbsp;</span></span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #ba2121;">    ORDER BY time Asc Limit </span><span style="color: #bb6688; font-weight: bold;">$block_size</span><span style="color: #ba2121;">"</span>);<br /><br />    <span style="color: #19177c;">$moredata_available</span> <span style="color: #666666;">=</span> <span style="color: #666666;">0</span>;<br />    <span style="color: green; font-weight: bold;">while</span>(<span style="color: #19177c;">$row</span> <span style="color: #666666;">=</span> db_fetch_array(<span style="color: #19177c;">$result</span>)) {<br /><br />      <span style="color: #408080; font-style: italic;">// Write block as csv to output stream</span><br />      <span style="color: green;">fputcsv</span>(<span style="color: #19177c;">$fh</span>, <span style="color: green; font-weight: bold;">array</span>(<span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'time'</span>],<span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'data'</span>]));<br /><br />      <span style="color: #408080; font-style: italic;">// Set new start time so that we read the next block along</span><br />      <span style="color: #19177c;">$start</span> <span style="color: #666666;">=</span> <span style="color: #19177c;">$row</span>[<span style="color: #ba2121;">'time'</span>];<br />      <span style="color: #19177c;">$moredata_available</span> <span style="color: #666666;">=</span> <span style="color: #666666;">1</span>;<br />    }<br />    <span style="color: #408080; font-style: italic;">// 2) Sleep for a bit</span><br />    <span style="color: green;">usleep</span>(<span style="color: #19177c;">$sleep</span>);<br />  }<br /><br />  <span style="color: green;">fclose</span>(<span style="color: #19177c;">$fh</span>);<br /></pre></div><br />In the next post I will discuss creating a script to import feed data by pointing directly at the export script on the other server, plus a background running&nbsp;daemon&nbsp;process and queueing&nbsp;mechanism&nbsp;to manage the import process.