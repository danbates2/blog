---
layout: post
title: Website Backup
date: '2013-10-01T03:47:00.001-07:00'
author: Glyn Hudson
categories:
- backup
modified_time: '2013-10-01T03:59:08.262-07:00'
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-4619968582397395834
blogger_orig_url: http://openenergymonitor.blogspot.com/2013/10/website-backup.html
---

In the interest of open-source I thought I would share the backup setup we have running for the OpenEnergyMonitor website. I'm relatively new to sys-admin tasks and writing bash scripts so please suggest if you think if something could be implemented better.<br /><br />Backing up our Drupal SQL databases which contain the user credentials and all the forum and text content of the website was relatively easy since the disk space they take up is relatively small. A nightly SQL dump then a scheduled secure FTP bash script running as a nightly cronjob on a Raspberry Pi with external hard drive to download the zipped SQL database does the trick. The FTP login credentials are stored away from prying eyes in .netrc file (with chmod 600), two sets of credentials are required and the relevant .netrc file is copied to the home folder when needed.<br /> <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?lang=css&amp;skin=sunburst"></script> <br /><pre class="prettyprint">cp netrc/.netrc1 .netrc<br />today=$(date +"%d-%b-%Y")<br />ftp -vp -z secure $HOST &lt;&lt; EOT<br />ascii<br />cd /LOCATION OF SQL DUMP ON SERVER<br />get $db_name-$today_backup.gz $LOCAL_BACKUP/$db_name-$today_backup.gz<br />bye<br />EOT<br />rm .netrc<br /><br /></pre><br />&nbsp;Backing up the files (images, documents etc) is a bit more of an issue since the ever increasing size of the content mean it's impractical and would unnecessary load the server and bandwidth to download a full snapshot every night.<br /><br />I found wget has many customisable options. A nightly scheduled bash script running on a Raspberry Pi with an external hard drive with the following wget options looks at files have been created or modified since the last time the command was run and only downloads the changes. Once the initial download is done the command only takes less then a minute to execute and often only downloads a few Mb of data. The option '-N' tells wget only to download new or modified files<br /><br /><pre class="prettyprint">cp netrc/.netrc2 .netrc<br />wget -m -nv -N -l 0 -P $LOCAL_BACKUP ftp://$HOST/public_html/FILES_LOCATION -o $LOCAL_BACKUP/filelog=$today.txt<br />rm .netrc<br /># This is what the other options do:<br /># -l 0 infinite level of recursive (folder depth)<br /># -m mirror<br /># -N only download new files<br /># -o logfile<br /># -b run in the background<br /># -q turn off logs<br /># -nv non-verbose logs<br /></pre>This setup seems to be working well. It has a few weak points and limitations that I can think of:<br /><ul><li>The wget files backup script only downloads new and modified files, it does not mirror the fact that a file could have been deleted on the server, the file would remain in the backup.&nbsp;</li></ul><ul><li>The wget script does not keep historical snapshots meaning that if something bad was to happen it would not be possible to rollback to a certain date in history. <i>Update: I have since had recommend to me Rsnapshot which is a backup utility based on Rsync. Rsnapshot looks great and can work over FTPS. My friend <a href="https://twitter.com/spikeheap">Ryan Brooks</a> wrote a good blog post on how to <a href="http://www.ryanbrooks.co.uk//blog/2013/08/22/simple-rsnapshot-backup-over-ftps/">set up Rsnapshot over FTPS</a>.&nbsp;</i></li></ul><ul><li>Currently the Raspberry Pi only has the one external 1TB hard drive used for backup, ideally this would be two hard drives in a raid array for double safety Backups are only done nightly, this is plenty good enough for us at the moment but might need to be improved in the future.&nbsp;</li></ul><br />I think it's amazing that a little Â£25 Raspberry Pi is powerful enough to handle backup for several websites. the Pi with an external 1TB hard drive connected through a USB hub consumes only 5.7W making it not too bad to leave on 24/7.<br /><br />&nbsp;One issue that I had initially with the Pi is that the external hard driver would move from /dev/sdb to /dev/sdc therefore loosing it's mount point. I think this was caused by the HDD momentarily losing power. Switching to using a<a href="http://shop.pimoroni.com/products/pihub"> Pimoroni PiHub</a> to power the setup and mounting the drive by it's UUID instead of /dev/xxx reference in fstab fixed the problem:&nbsp; <br /><br /><pre class="prettyprint">UUID=2921-FCE8 /home/pi/1TB vfat  user,umask=0000   0   0</pre><br />I would be interested to hear if you think how the backup could be implemented more efficiently or more securely.