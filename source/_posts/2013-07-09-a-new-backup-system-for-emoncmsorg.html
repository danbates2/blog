---
layout: post
title: A new backup system for emoncms.org
date: '2013-07-09T15:42:00.001-07:00'
author: Trystan Lea
categories:
- backup
- emoncms
modified_time: '2013-07-25T08:04:10.377-07:00'
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-6434968957500520796
blogger_orig_url: http://blog.openenergymonitor.org/2013/07/a-new-backup-system-for-emoncmsorg.html
---

The current emoncms.org backup system works by using two&nbsp;separate&nbsp;servers with data being synced from the main one to the second backup server using the same implementation used in the emoncms sync module&nbsp;<a href="http://openenergymonitor.blogspot.co.uk/2013/05/emoncmsorg-backup.html">http://openenergymonitor.blogspot.co.uk/2013/05/emoncmsorg-backup.html</a><br /><div><br /></div><div>A couple of weeks after getting all that setup BigV announced a new feature: archive storage which they say is ideal for backups. Archive storage works in much the same way as connecting a second external drive to a computer. Archive storage on bigv is guaranteed to be on a separate storage pool from the main vm disc which is good news as it&nbsp;wasn't&nbsp;guaranteed that the two&nbsp;separate&nbsp;server method used seperate storage pools (If I understand correctly)</div><div><a href="http://blog.bytemark.co.uk/2013/06/13/archive-storage-and-web-based-vm-manager-launched">http://blog.bytemark.co.uk/2013/06/13/archive-storage-and-web-based-vm-manager-launched</a></div><div><br /></div><div>Another advantage to the new archive storage is that its much cheaper to run, costing £2/month for 50GB rather than £16/month for another vm and 30GB extra space.</div><div><br /></div><div>A simple php script is used to perform the backup, it makes use of the direct file access stuff I recently learnt about (<a href="http://openenergymonitor.blogspot.co.uk/2013/07/more-direct-file-storage-research.html">http://openenergymonitor.blogspot.co.uk/2013/07/more-direct-file-storage-research.html</a>)&nbsp;to do incremental backup file copy using php file access commands making it potentially very fast, it can backup files at full file copy speeds:</div><div><a href="https://github.com/emoncms/usefulscripts/blob/master/backup_method2.php">https://github.com/emoncms/usefulscripts/blob/master/backup_method2.php</a></div><div><br /></div><div>It accesses the mysql data directly, copying the content of the mysql feed data file i.e: &nbsp;/var/lib/mysql/emoncms/feed_1.MYD to the backup drive.</div><div><br /></div><div>On another slightly related note the data in&nbsp;feed_1.MYD is stored simply as:</div><div><br /></div><div>1 byte for null flag</div><div>4 bytes for the timestamp</div><div>4 bytes for the float data value<br />repeated...</div><div><br /></div><div>and because the readings are inserted one after the other in ascending time we can actually use the mysql feed data files directly with the direct file get_feed_data method to get 10-20x query speed improvement for generating visualisations: <a href="https://github.com/emoncms/experimental/blob/master/storage/directfiles/get_feed_data.php">https://github.com/emoncms/experimental/blob/master/storage/directfiles/get_feed_data.php</a></div><div><br /></div><div>We could even get rid of the mysql feed table index's to save disk space although that will probably slow down mysql updates (I need to look into it). This could be a short term measure before a full timestore emoncms implementation is complete which provides many other benefits.</div>