---
layout: post
title: Idea for using redis in-memory database to improve emoncms performance
date: '2013-06-25T00:35:00.001-07:00'
author: Trystan Lea
categories:
- emoncms
modified_time: '2013-06-25T00:38:40.547-07:00'
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-1872763114143340355
blogger_orig_url: http://blog.openenergymonitor.org/2013/06/idea-for-using-redis-in-memory-database.html
---

Most of the time taken to handle posting data to emoncms, (input processing and feed updating) is taken up by requests to the mysql database. The php part of the code is usually pretty fast especially with Opcode cashing enabled such as APC.<br /><br />Reducing the number of MYSQL queries required is usually a sure way to improve the performance of the application. Back in March of this year I&nbsp;re-factored&nbsp;the input processing implementation removing a lot of un-needed repeated queries as described at the bottom of this page:&nbsp;<a href="http://emoncms.org/site/docs/developinputproc">http://emoncms.org/site/docs/developinputproc</a><br />The results where really good, see the pic of <a href="https://twitter.com/Openenergymon/status/313238459965915136/photo/1">time spent serving queries here</a><br /><div><br /></div><div>I've been thinking about how to improve this further, mysql queries are used a lot for getting the last value of a feed or input, its used for all the +,-,x,/ input processes, the Power to kWh/d, histogram processes, in-fact most of the processes. When a new datapoint is added to a feed data table emoncms also updates the last time and value into the feeds table every time. This is then used by the input processors and also to provide the &nbsp;live view on the feeds page.</div><div><br /></div><div>None of these input or feed last updated time/value reads and write queries need to be&nbsp;persistent&nbsp;beyond the very short term that an in-memory database would be fine for. Using an in-memory database like redis should be much faster than going to the hard disk or SD card and so hopefully implementing this will lead to a good performance improvement. It also has benefits for&nbsp;longevity&nbsp;of the raspberrypi SD card as it reduces SD card writes.&nbsp;That's the idea anyway, here's a bit of basic testing of using redis, the next step is to try to implement this in emoncms.</div><div><br /><b>Install redis and&nbsp;redis php client&nbsp;ubuntu</b><br /><b><br /></b><span style="font-family: Courier New, Courier, monospace;">sudo apt-get install redis-server</span><br /><br />Install PHP redis client https://github.com/nrk/predis. To install using PEAR which we've already been using for installation of the serial dio library used by the raspberrypi module, call the following:&nbsp;</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">sudo apt-get install php-pear php5-dev (if you dont already have pear installed)&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">pear channel-discover pear.nrk.io</span></div><div><span style="font-family: Courier New, Courier, monospace;">pear install nrk/Predis  </span><br /><br /><b>Trying redis out:</b>&nbsp;</div><div><br />&lt; ?php<br /><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">require 'Predis/Autoloader.php';</span></div><div><span style="font-family: Courier New, Courier, monospace;">Predis\Autoloader::register();</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">$redis = new Predis\Client();</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">// 1) Set redis in-memory key-value pair to hold feed meta and last value data</span></div><div><span style="font-family: Courier New, Courier, monospace;">// ONCE SET COMMENT OUT THIS LINE TO SEE THAT feed_1 DATA IS PERSISTENT&nbsp;</span></div><div><span style="font-family: Courier New, Courier, monospace;">// BETWEEN CALLS TO THIS SCRIPT - AS LONG AS MEMORY IS NOT RESET.</span></div><div><span style="font-family: Courier New, Courier, monospace;">$redis-&gt;set('feed_1',json_encode(array('name'=&gt;"Solar Power",'time'=&gt;time(),'value'=&gt;1800)));</span></div><div><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">// 2) Fetch the feed_1 entry from in-memory db</span></div><div><span style="font-family: Courier New, Courier, monospace;">echo $redis-&gt;get('feed_1');</span></div></div><div><br /></div><div>Redis is also used by Jean Claude Wippler in HouseMon which is cool:<br /><a href="https://github.com/jcw/housemon">https://github.com/jcw/housemon</a><br /><a href="http://jeelabs.org/tag/housemon/">http://jeelabs.org/tag/housemon/</a><br />I'd like to learn more about how HouseMon works, take a little time to get a HouseMon install up and running and familiarise myself with the code and architecture as it looks really nice!</div>