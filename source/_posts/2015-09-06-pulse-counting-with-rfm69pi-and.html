---
layout: post
title: Pulse counting with the RFM69PI and RaspberryPi EmonBase basestation
date: '2015-09-06T14:08:00.002-07:00'
author: Trystan Lea
categories:
- optical pulse
- emonBase
modified_time: '2015-09-20T19:09:15.214-07:00'
thumbnail: http://3.bp.blogspot.com/-EScDwqHXgyw/VeylN7yKW2I/AAAAAAAAT2w/HzWr5pXAwMg/s72-c/rfmpi_pulse.JPG
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-7191416459604277671
blogger_orig_url: http://openenergymonitor.blogspot.com/2015/09/pulse-counting-with-rfm69pi-and.html
---

The latest version of the RFMPi Adapter board made much of the spare digital and analog IO available for use directly on the RFMPi adapter board. D3 is one of the digital inputs available and can have an interrupt attached (INT 1) which makes it useful for pulse counting.<br /><br />By connecting a<a href="http://shop.openenergymonitor.com/optical-utility-meter-led-pulse-sensor/"> optical pulse sensor</a> directly to the <a href="http://shop.openenergymonitor.com/emonbase-raspberry-pi-web-connected-base-station/">rfm69pi adapter board</a> this can make a relatively low cost solution for internet connected pulse counting (or local logging to emoncms running on the raspberrypi). <br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-EScDwqHXgyw/VeylN7yKW2I/AAAAAAAAT2w/HzWr5pXAwMg/s1600/rfmpi_pulse.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="223" src="http://3.bp.blogspot.com/-EScDwqHXgyw/VeylN7yKW2I/AAAAAAAAT2w/HzWr5pXAwMg/s400/rfmpi_pulse.JPG" width="400" /></a></div><br /><b>Setup</b><br /><br />1) The RJ45 connector on the optical pulse counter needs to be removed and individual wires exposed. Connect the red wire to 3.3V, the black wire to GND and the blue wire to D3:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-svvRwhAQZc4/VeylOJ16QRI/AAAAAAAAT20/2s3CJ9OcOlw/s1600/rfmpi_pulse_connections.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="300" src="http://4.bp.blogspot.com/-svvRwhAQZc4/VeylOJ16QRI/AAAAAAAAT20/2s3CJ9OcOlw/s400/rfmpi_pulse_connections.JPG" width="400" /></a></div><br />2) To use the rfm69pi adapter with pulse counting the pulse counting firmware needs to be uploaded to the rfm69pi adapter board, the steps to upload this firmware are:<br /><ol><li>SSH into your raspberrypi running the standard OpenEnergyMonitor image.</li><li>Place raspberrypi in write mode: <br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ rpi-rw</span></li><li>Stop emonhub: <br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ sudo service emonhub stop</span></li><li>Pull in latest changes to RFM2Pi git directory: <br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ cd RFM2Pi<br />$ git pull</span></li><li>Upload pulse counting firmware:<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ avrdude -v -c arduino -p ATMEGA328P -P /dev/ttyAMA0 -b 38400 -U flash:w:/home/pi/RFM2Pi/firmware/dev/RFM69CW_RF12_Demo_ATmega328_Pulse/RFM69CW_RF12_Demo_ATmega328_Pulse.cpp.hex</span></li><li>Start emonhub:<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">$ sudo service emonhub start</span></li></ol>Next login to the local emoncms installation on the raspberrypi and navigate to the emonhub.conf editor. Add the following node definition in the nodes section of emonhub.conf:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">[[15]]<br />&nbsp;&nbsp;&nbsp; nodename = rfmpi_pulse<br />&nbsp;&nbsp;&nbsp; firmware = RFM69CW_RF12_Demo_ATmega328_Pulse<br />&nbsp;&nbsp;&nbsp; hardware = rfm69pi<br />&nbsp;&nbsp;&nbsp; [[[rx]]]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; names = power,count<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; datacodes = h,L<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scales = 1,1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; units = W,Wh&nbsp;</span><br /><br />The pulse count is accumulated on the rfm69pi until the rfm69pi is reset either by an outage or by turning off and on the power.<br /><br />To record the total accumulated pulse count in emoncms use the  wh_accumulator input process which detects resets continuing the total  pulse count accumulation from the last value before the reset.
