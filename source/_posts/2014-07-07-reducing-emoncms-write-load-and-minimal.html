---
layout: post
title: Reducing emoncms write load and a minimal python version of emoncms
date: '2014-07-07T05:36:00.001-07:00'
author: Trystan Lea
categories:
- emoncms
modified_time: '2014-07-10T08:51:30.623-07:00'
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-8597455864650284726
blogger_orig_url: http://openenergymonitor.blogspot.com/2014/07/reducing-emoncms-write-load-and-minimal.html
---

Over the last few weeks I have been investigating how to reduce the write load of emoncms to explore if it might be possible to achieve long term logging on SD cards.<br /><br /><b>A brief summary</b><br /><br />Through a mix of buffered writing of feed data to disk, reduction of the number of meta and average data files written to and use of the FAT filesystem, my home raspberrypi now has a write load of 0.4kb_wrtn/s down from 197kb_wrtn/s.. almost 500x less and the writes are all append only (there's no regular writing of the same part of a file again and again). The question is could this mean years of SD card logging rather than months?<br /><br /><b>Write buffering</b><br /><br />A single Emoncms PHPFina (PHP Fixed Interval No averaging) or PHPTimeSeries datapoint uses between 4 and 9 bytes. The write load on the disk however is a bit more complicated than that. Most filesystems and disk's have a minimum IO size that is much larger than 4-9 bytes, on a FAT filesystem the minimum IO size is 512 bytes this means that if you try and write 4 bytes the operation will actually cause 512 bytes of write load. But its not just the datafile that gets written to, every file has inode meta data which can also result in a further 512 bytes of write load. A single 4 byte write can therefore cause 1kb of write load.<br /><br />By buffering writes for as long as we can in memory and then writing in larger blocks its possible to reduce the write load significantly. The full investigation with a lot of benchmarking of different configurations including differences between FAT and Ext4 can be found here:<br /><br /><a href="https://github.com/openenergymonitor/documentation/blob/master/BuildingBlocks/TimeSeries/writeloadinvestigation.md">https://github.com/openenergymonitor/documentation/blob/master/BuildingBlocks/TimeSeries/writeloadinvestigation.md</a><br /><br /><b>A minimal version of emoncms in python</b><br /><br />To make the investigation easier I simplified emoncms down to the core parts needed on a raspberrypi to get basic timeseries graphing: serial listener, node decoder, basic feed engine and a ui consisting of a nodelist and a single rawdata visualisation type and wrote the result in python making use of Jerome and Paul's (pb66) excellent work on the emonhub serial listener and node decoder.<br />Here's a diagram of the main components of the python app:<br /><img alt="" src="http://openenergymonitor.org/emon/sites/default/files/emon-py-system-diagram.png" style="height: 387px; width: 600px;" /><br /><br />And some screenshots of what it looks like:<br /><br />Node list:<br /><br /><img alt="" src="http://openenergymonitor.org/emon/sites/default/files/emon-py_0.png" style="height: 409px; width: 600px;" /><br /><br />Basic graphing:<br /><br /><br /><br /><img alt="" src="http://openenergymonitor.org/emon/sites/default/files/graph_1.png" style="height: 283px; width: 600px;" /><br /><br />The source code and an installation guide for this minimal python version of emoncms can be found here:<br /><br /><a href="https://github.com/emoncms/development/tree/master/experimental/emon-py">https://github.com/emoncms/development/tree/master/experimental/emon-py</a><br /><br /><b>Further development questions</b> (copied from the end of the write load investigation page)<br /><br />Is the reduced write load and longer SD card lifespan that might result from using the FAT filesystem worth the increased chance of data corruption from power failure that Ext4 might prevent?<br /><br />It would be interesting to compare the performance of the FAT filesystem + 5 min application based commit time with the EXT4 filesystem with Journaling turned off and filesystem delayed allocation set to 5 min instead of write buffering in the application.<br /><br /><br />I posted on the EmonHub issues list about this last friday and  I've been having a bit of a discussion there with Paul  <a href="https://github.com/emonhub/emonhub/issues/48">https://github.com/emonhub/emonhub/issues/48</a><br /><br />I've also posted this on the forum's here: <br /><a href="http://openenergymonitor.org/emon/node/5387">http://openenergymonitor.org/emon/node/5387 </a>