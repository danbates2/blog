---
layout: post
title: 'From 1.3 minutes to 196ms: timestore on emoncms.org'
date: '2013-07-31T04:14:00.000-07:00'
author: Trystan Lea
categories:
- emoncms
modified_time: '2013-08-05T09:02:51.239-07:00'
thumbnail: http://3.bp.blogspot.com/-hOkV9mZtczY/UfjjBpy62ZI/AAAAAAAACvU/y1WT69TFM4U/s72-c/mysql_yearview.png
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-771972073264109767
blogger_orig_url: http://openenergymonitor.blogspot.com/2013/07/from-13-minutes-to-196ms-timestore-on.html
---

<br /><div style="margin-bottom: 0cm;">John Cantor who uses the openenergymonitor system for <a href="http://www.heatpumps.co.uk/">heatpump performance monitoring</a>&nbsp;got in contact the other day saying that graphs on emoncms.org where taking a really long time to load. I said that the work on using <a href="http://www.mike-stirling.com/redmine/projects/timestore">timestore</a> will soon speed things up significantly. He asked if there was a chance to convert the feeds before he went up to work on a system in Scotland as being able to zoom with speed through the graphs would make a big difference.</div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;">Clicking on the Y (Year) button in the rawdata visualisation has slowed down so much over the last year that it now takes over a minute to load the view.</div><div style="margin-bottom: 0cm;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-hOkV9mZtczY/UfjjBpy62ZI/AAAAAAAACvU/y1WT69TFM4U/s1600/mysql_yearview.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="281" src="http://3.bp.blogspot.com/-hOkV9mZtczY/UfjjBpy62ZI/AAAAAAAACvU/y1WT69TFM4U/s400/mysql_yearview.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;">The same request on a raspberrypi takes <a href="http://openenergymonitor.blogspot.co.uk/2013/06/rethinking-data-input-and-storage-core.html">2.9 seconds</a>, The thinking to why its so much slower on emoncms.org is because of the use of the php loop doing individual requests to mysql which are added to the mysql process queue and have to wait in line&nbsp;amongst&nbsp;all the other mysql inserts and updates caused by all the updating feeds, the php loop method was<a href="http://emoncms.org/site/docs/developdatastorage"> initially faster than an equivalent mysql implementation</a> but clearly not for long.</div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;">Anyway I figured we could get timestore up and running on emoncms.org straight away if we run timestore in parallel with the current mysql storage and then slowly convert feeds over to timestore over time.&nbsp;The present input processing and visualisation implementation would be kept as is for the time being only initially using timestore to replace the realtime datatype<a href="http://openenergymonitor.blogspot.co.uk/2013/07/emoncms-powered-by-timestore.html"> rather than both realtime and daily</a>.</div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;">Conversion from mysql to timestore takes a long time especially as the process has to be throttled down in order to allow enough resources on the server for normal operation to continue. For example the conversion of a 568 day long, 5s datapoint interval feed (~152mb) takes about half an hour loading the server to an average 15min (quite high) load of 4.69 at that rate it will take about a month to convert all feeds over to timestore.</div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;">The results though are worth it!:</div><div style="margin-bottom: 0cm;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-xmRfvjUVfPk/UfjrE7OGHJI/AAAAAAAACvk/vtYOubE9enw/s1600/timestore.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="272" src="http://2.bp.blogspot.com/-xmRfvjUVfPk/UfjrE7OGHJI/AAAAAAAACvk/vtYOubE9enw/s400/timestore.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: x-large;">196ms!</span></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div style="margin-bottom: 0cm;">1.3 minutes down to 196ms is a<b> 398x</b> speed increase! and its also possible to see another advantage of timestore the effect of the average layers showing a slight winter summer curve. A big thankyou and credit to Mike Stirling for developing timestore enabling this kind of performance, if you&nbsp;haven't&nbsp;already check out the timestore project website:</div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;"><a href="http://www.mike-stirling.com/redmine/projects/timestore">http://www.mike-stirling.com/redmine/projects/timestore</a></div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;">John Cantor has shared the Scottish heatpump dashboard publicly, take a look to try out the new timestore feeds:</div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;"><a href="http://emoncms.org/mallard">http://emoncms.org/mallard</a></div><div style="margin-bottom: 0cm;"><br /></div><div style="margin-bottom: 0cm;">Im currently working on an interface in emoncms to allow selection of the feed datapoint interval (5s, 10s, 30s etc) to convert to before the feeds are added to the conversion queue, more on this soon.</div>