---
layout: post
title: Timestore timeseries database
date: '2013-06-03T07:03:00.000-07:00'
author: Trystan Lea
categories:
- emoncms
modified_time: '2013-06-15T13:14:16.166-07:00'
blogger_id: tag:blogger.com,1999:blog-2472065242652647619.post-7860379501999897865
blogger_orig_url: http://blog.openenergymonitor.org/2013/06/timestore-timeseries-database.html
---

The first and most developed solution to both the query speed problem and disk space problem is timestore.<br /><br /><a href="http://www.mike-stirling.com/redmine/projects/timestore" style="color: #3465a4;">http://www.mike-stirling.com/redmine/projects/timestore</a><br /><br />Timestore is a lightweight time-series database developed by Mike Stirling. It uses a NoSQL approach to store an arbitrary number of time points without an index.<br /><br /><b>Query speeds</b><br />Timestore is fast, here's the figures given by Mike Stirling on the documentation page:<br /><br />From the resulting data set containing 1M points spanning about 1 year on 30 second intervals:<br /><br />Retrieve 100 points from the first hour: 2.6 ms<br />Retrieve 1000 points from the first hour (duplicates inserted automatically): 6.2 ms<br />Retrieve 100 points over the entire dataset (about a year worth): 2.5 ms<br />Retrieve 1000 points over the entire dataset: 7.0 ms<br /><br /><b>Disk use</b><br /><br />Timestore uses a double as a default data type which is 8 bytes. The current emoncms mysql database stores data values as floats which take up 4 bytes, its easy to change the data type in timestore so for a fair comparison we can change the default datatype to a 4-byte float:<br /><br />Layer 1: 10s layer = 3153600 datapoints x 4 bytes = 12614400 bytes<br />Layer 2: 60 layer1 datapoints averaged = 52560 datapoints x 4 bytes = 210240 Bytes<br />Layer 3: 10 layer2 datapoints averaged = 5256 datapoints x 4 bytes = 21024 bytes<br />Layer 4: 6 layer3 datapoints averaged = 876 datapoints x 4 bytes = 7008 bytes<br />Layer 5: 6 layer4 datapoints averaged = 146 datapoints x 4 bytes = 1168 bytes<br />Layer 6: 4 layer5 datapoints averaged = 36 datapoints x 4 bytes = 288 bytes<br />Layer 7: 7 layer6 datapoints averaged = 5 datapoints x 4 bytes = 40 bytes<br /><br /><b>total size = 12854168 Bytes or 12.26Mb</b><br /><br />The current emoncms data storage implementation uses 60Mb to hold the same data as it saves both the timestamp and an associated index. Timestore therefore has the potential to reduce diskuse by 80% for realtime data feeds.<br /><br />Interestingly all the downsampled layers created by timestore only come too <b>0.23 Mb</b>. Before doing the calculation above I used to think that adding all the downsampled layers would add to the problem of disk space significantly but evidently it a very small contribution compared with the full resolution data layer.<br /><br /><b>Emoncms timestore development branch</b><br /><br />I made a start on integrating timestore in emoncms, there's still a lot to do to make it fully functional but it works as a demo for now, here's how to get it setup:<br /><br /><b>1) Download, make and start timestore</b><br /><br />$ git clone <a href="http://mikestirling.co.uk/git/timestore.git" style="color: #3465a4;">http://mikestirling.co.uk/git/timestore.git</a><br />$ cd timestore<br />$ make<br />$ cd src<br />$ sudo ./timestore -d<br /><br />Fetch the admin key<br /><br />$ cd <a href="http://www.blogger.com/var/lib/timestore" style="color: #3465a4;">/var/lib/timestore</a><br />$ nano adminkey.txt<br /><br />copy the admin key which looks something like this: POpP)@H=1[#MJYX&lt;(i{YZ.0/Ni.5,g~&lt;<br />the admin key is generated anew every time timestore is restarted.<br /><br /><b>2) Download and setup the emoncms timestore branch</b><br /><br />Download copy of the timestore development branch<br /><br />$ git clone -b timestore <a href="https://github.com/emoncms/emoncms.git" style="color: #3465a4;">https://github.com/emoncms/emoncms.git</a> timestore<br /><br />Create a mysql database for emoncms and enter database settings into settings.php.<br /><br />Add a line to settings.php with the timestore adminkey:<br />$timestore_adminkey = "POpP)@H=1[#MJYX&lt;(i{YZ.0/Ni.5,g~&lt;";<br /><br />Create a user and login<br /><br />The development branch currently only implements timestore for realtime data and the feed/data api is restricted to timestore data only which means that daily data does not work. The use of timestore for daily data needs to be implemented.<br /><br />The feed model methods implemented to use timestore so far are create, insert_data and get_data.<br /><br /><b>Try it out</b><br /><br />Navigate to the feeds tab, click on feed API helper, create a new feed by typing:<br /><a href="http://localhost/timestore/feed/create.json?name=power&amp;type=1" style="color: #3465a4;">http://localhost/timestore/feed/create.json?name=power&amp;type=1</a><br /><br />It should return {"success":true,"feedid":1}<br /><br />Navigate back to feeds, you should now see your power feed in the list.<br />Navigate again to the api helper to fetch the insert data api url<br /><br />Call the insert data api a few times over say a minute (so that we have at least 6 datapoints - one every 10 seconds).&nbsp;Vary the value to make it more interesting:<br /><a href="http://localhost/timestore/feed/insert.json?id=1&amp;value=100.0" style="color: #3465a4;">http://localhost/timestore/feed/insert.json?id=1&amp;value=100.0</a><br /><br />Select the rawdata visualisation from the vis menu<br /><a href="http://localhost/timestore/vis/rawdata&amp;feedid=1" style="color: #3465a4;">http://localhost/timestore/vis/rawdata&amp;feedid=1</a><br /><br />zoom to the last couple of minutes to see the data.<br /><br /><br />I met Mike Stirling a little over a month ago in Chester for a beer and a chat after Mike originally got in contact to let me know about timestore. We discussed data storage, secure authentication, low cost temperature sensing and <a href="http://www.earth.org.uk/open-source-programmable-thermostatic-radiator-valve.html">openTRV</a> the project Mike is working on. I think there could be great benefit to work on making what we're developing here with openenergymonitor interoperable with what Mike and others are developing with openTRV, especially as we develop more building heating and building fabric performance monitoring tools. This could all develop into a super nice open source whole building energy (both electric and heat) monitoring and control ecosystem of hardware and software tools.<br /><br />Check out Mike's blog here:<br /><br /><a href="http://www.mike-stirling.com/">http://www.mike-stirling.com/</a><br />and&nbsp;<a href="http://www.earth.org.uk/open-source-programmable-thermostatic-radiator-valve.html">http://www.earth.org.uk/open-source-programmable-thermostatic-radiator-valve.html</a>