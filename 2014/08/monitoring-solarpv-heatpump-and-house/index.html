<!doctype html>
  <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
  <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
  <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
  <!--[if gt IE 8]><!--> <html> <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Monitoring SolarPV, Heatpump and house electric, EmonTx v2 system upgrade example - Blog | OpenEnergyMonitor</title>
    <meta name="author" content="Glyn Hudson">
    <meta name="description" content="OpenEnergyMonitor Blog">
    
    <meta name="viewport" content="width=device-width">
    <link rel="canonical" href="https://blog.openenergymonitor.org/2014/08/monitoring-solarpv-heatpump-and-house/">

    <meta property="fb:app_id" content="">
    <meta property="og:title" content="Monitoring SolarPV, Heatpump and house electric, EmonTx v2 system upgrade example">
    <meta property="og:site_name" content="Blog | OpenEnergyMonitor">
    <meta property="og:url" content="https://blog.openenergymonitor.org/2014/08/monitoring-solarpv-heatpump-and-house/">
    <meta property="og:type" content="article">
    <meta property="og:description" content="">
    <meta property="og:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@openenergymon">
    
    <meta name="twitter:title" content="Monitoring SolarPV, Heatpump and house electric, EmonTx v2 system upgrade example">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://guide.openenergymonitor.org/images/favicon-192x192.png">

    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet">
    <link href="/atom.xml" rel="alternate" title="Blog | OpenEnergyMonitor" type="application/atom+xml">
    <link rel='shortcut icon' href='/images/favicon.ico' />
    <link rel='icon' type='image/png' href='/images/favicon-192x192.png' sizes='192x192' />
    
    
    
    <link rel="shortcut icon" href="/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="/favicon.ico">
	<link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-192.png">
	<link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96.png">
	<link rel="icon" type="image/png" sizes="64x64" href="/images/favicon-64.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
	<link rel="apple-touch-icon" href="/images/favicon-57.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/images/favicon-114.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/images/favicon-72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/images/favicon-144.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/images/favicon-60.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/images/favicon-120.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/images/favicon-76.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/images/favicon-152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-180.png">
	<meta name="msapplication-TileColor" content="#FFFFFF">
	<meta name="msapplication-TileImage" content="/images/favicon-144.png">
	<meta name="msapplication-config" content="/images/browserconfig.xml">
	
  </head>

  <body >

    <header>
      <div class="grid-wrapper">
  <div class="grid">

    <div class="grid__item three-tenths lap-two-sixths palm-one-whole ha-title">
  <a href="/" class="site-title">
    <!--<img width='40' src='/images/favicon-192x192.png'> -->
    
    <span style="color:#555;font-weight:bold;font-family:Arial;font-size:20"'>
Open</span><span style="color:#0699fa;font-weight:bold;font-family:Arial;font-size:20"'>EnergyMonitor</span>

  </a>
</div>

<div class="grid__item seven-tenths lap-four-sixths palm-one-whole">
  <nav>
    <input type="checkbox" id="toggle">
<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
<ul class="menu pull-right">
  <li><a href="http://openenergymonitor.org">Home</a></li>
  <li><a href="http://shop.openenergymonitor.com">Online-Store</a></li>
  <li><a href="http://guide.openenergymonitor.org">User Guide</a></li>
  <li><a href="http://emoncms.org">Emoncms</a></li>
  <li><a href="http://community.openenergymonitor.org">Forum</a></li>
</ul>
  </nav>
</div>

  </div>
</div>
    </header>

    

    <div class="grid-wrapper">
      <div class="grid grid-center">
        
        <div class="grid__item two-thirds lap-one-whole palm-one-whole">
        

          <article class="post">
  <div class='edit-github'><a href='https://github.com/openenergymonitor/blog/tree/master/source/_posts/2014-08-06-monitoring-solarpv-heatpump-and-house.html'>Edit this post on GitHub</a></div>
  
  <header>
  
  <h1 class="title indent">Monitoring SolarPV, Heatpump and house electric, EmonTx v2 system upgrade example</h1>
  

  
  <div class="meta clearfix">
    <time datetime="2014-08-06T17:25:00+00:00" pubdate data-updated="true"><i class="icon-calendar"></i> 2014-08-06 17:25:00 +00002014-08-06 17:25:00 +0000
    <span class="byline author vcard"><i class='icon-user'></i> Trystan Lea</span> <br>
    <span><i class='icon-time'></i> five minutes reading time</span> <br>
    <span>
    <i class="icon-tags"></i>
    <ul class="tags unstyled">
    
      
        <li><a class='category' href='/categories/heat-pump/'>Heat Pump</a></li>
      
        <li><a class='category' href='/categories/emontx-v2/'>emonTx V2</a></li>
      
        <li><a class='category' href='/categories/upgrade/'>upgrade</a></li>
      
    
    </ul>
  </span> <br>
    
      <a class='comments'
         href="/2014/08/monitoring-solarpv-heatpump-and-house/#disqus_thread"
         >Comments</a>
    
  </div>
  
</header>


  Several years ago we did a community energy monitoring project in our local area, Penrhyndeudraeth, North Wales. It involved installing 20 openenergymonitor energy monitors in 20 households and carrying out energy assessment looking at electricity, heating and transport, there is a little more about it and some of the tools we developed <a href="http://openenergymonitor.blogspot.co.uk/2012/01/community-energy-plan-maker.html">here.</a><br /><br />The houses that where most engaged in the monitoring part of the project still have those energy monitors installed and yesterday I went to upgrade one of these systems, I thought Id write a blog post on what I did (written half as a guide) as it might be useful for those using older hardware such as the emonTx V2 and its also quite an interesting example of what you can do with the monitoring system.<br /><br />The upgrade essentially involved replacing a first generation nanode basestation with a RaspberryPI basestation running the latest image and also upgrading the emontx v2 that was in place with new firmware that both does the higher accuracy continuous sampling (developed by Robin Emley) and the watt hour calculation on board.<br /><br />This particular system is measuring Solar PV generation, household electric consumption and the electrical consumption of a heatpump. It has an EmonGLCD Display running the SolarPV firmware, with the red/green glowing ambient light depending on whether more power is being used than generated or vice versa and the data is also posted to emoncms.org for graphing.<br /><br />Here's a system diagram: <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-NSjTs-IBrD8/U-IYZE55v0I/AAAAAAAAFXI/miI26ZPQKDI/s1600/hp_pv_h_systemdiagram.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-NSjTs-IBrD8/U-IYZE55v0I/AAAAAAAAFXI/miI26ZPQKDI/s1600/hp_pv_h_systemdiagram.png" height="370" width="640" /><b></b></a></div><b>EmonTx:</b><br /><br />Upload to the EmonTxV2 the continuous sampling + watt hour firmware:<br /><a href="https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxV2/emonTx_continuous_watthours">https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxV2/emonTx_continuous_watthours&nbsp;</a><br /><br />The same thing can of course be achieved with an EmonTxV3 but with the added benefit of a fourth channel and only needing the one ACAC Power adapter. If you have the EmonTxV3 upload the continuous sampling + watt hour firmware found here:<a href="https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxV3/RFM12B/Examples/emonTxV3_continuous_kwhtotals_noeeprom"> https://github.com/openenergymonitor/emonTxFirmware/tree/master/emonTxV3/RFM12B/Examples/emonTxV3_continuous_kwhtotals_noeeprom </a><br /><br /><b>EmonGLCD</b><br />Open the SolarPV example: https://github.com/openenergymonitor/EmonGLCD/tree/master/SolarPV<br /><br />On <a href="https://github.com/openenergymonitor/EmonGLCD/blob/master/SolarPV/SolarPV.ino#L68">lines 68 and 69</a> change the emontx radio packet defenition from:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; typedef struct { int power1, power2, power3, Vrms; } PayloadTX;<br />&nbsp;&nbsp;&nbsp; PayloadTX emontx;</span></span><br /><br />to:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; typedef struct { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned long msgNumber; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int heatpump; // heatpump<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int power1; // house power<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int power2; // solar power<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long wh_CT1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long wh_CT2;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long wh_CT3;<br />&nbsp;&nbsp;&nbsp; } PayloadTX;<br />&nbsp;&nbsp;&nbsp; PayloadTX emontx;</span></span><br /><br />I've named the second variable here heatpump instead of power1 and then powers 1 to 3 because power1 and power2 are used as house power and solar power lower down in the firmware.<br /><br /><b>RaspberryPI Basestation</b><br />I used the latest (28th of July emonSD image) that has EmonHub (thanks to Jerome and Paul Burnell) and emoncms ready to go but without the local emoncms installation enabled, the PI was just used as an EmonHub gateway forwarder to emoncms.org. I used the nice pimoroni berryblack raspberrypi case so that the installation was tidy.<br /><br /><a href="http://files.openenergymonitor.org/emonSD-13-08-14.img.zip">Download ready-to-go image: emonSD-13-08-14.img.zip [link updated]</a> <br /><br />To configure EmonHub to post to emoncms.org, SSH into the raspberrypi and put the PI in read/write mode with:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; rpi-rw</span></span><br /><br />and then open the emonhub configuration file:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; nano /boot/emonhub.conf</span></span><br /><br />Set the dispatcher url to: http://emoncms.org and the apikey to your emoncms.org account write apikey.<br /><br />In order to decode the emontx continuous + watt hour radio packet add a node decoder to the nodes section in the emonhub config file at the bottom:<br /><br /><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; [nodes]<br />&nbsp;&nbsp;&nbsp; [[10]]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Datacodes = L,h,h,h,l,l,l</span></span><br /><br /><br />Secure the pi user by changing the password (the default password is raspberry)<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; passwd</span></span><br /><br />Place the PI back in read only mode:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; rpi-ro</span></span><br /><br /><b>Emoncms configuration</b><br /><br />With the emontx running and the raspberrypi configured as above the inputs will now appear in emoncms.org, but they will be un-named. For this particular installation I named them as in the picture below to correspond to the radio packet format and what I knew I was monitoring on each CT channel.<br /><br />I then logged each of the power inputs to a fixed interval with averaging (PHPFiwa) feed and used the Wh Accumulator input processor to record the Watt hour totals. The Wh Accumulator checks if the watt hour total has reset and if it does it continues the accumulation from the last point. I used the fixed interval without averaging feed engine for the watt hour feeds.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-MAZGbUyY-Q4/U-IhT7TGOdI/AAAAAAAAFXY/Oe5O3m7RZWc/s1600/inputconfig.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-MAZGbUyY-Q4/U-IhT7TGOdI/AAAAAAAAFXY/Oe5O3m7RZWc/s1600/inputconfig.png" height="524" width="640" /></a></div><br />To make use of the higher accuracy calculating of watt hours on the emontx and the recording of watt hour feeds<b>, </b>there is a slightly different procedure for creating dashboard kwh per day graphs: <br /><br /><b>Creating a daily electricity consumption graph in a dashboard using watt hour feeds (instead of the old power_to_kwhd method).&nbsp;</b>&nbsp; <b><br /></b><br /><br />Create a new dashboard and select visualisations &gt; bargraph.<br /><br />Click on the bargraph and click configure to bring up the configuration dialog. Select the watt hour feed that you want to display daily totals from, enter interval, units, dp, scale and delta=1 as below: (Note that you could change the interval here to any interval: hourly, half day, week etc)<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-Tn1o4o0gNUA/U-IwqaYrUlI/AAAAAAAAFXo/eTAOIhczZqU/s1600/bargraphconfig.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-Tn1o4o0gNUA/U-IwqaYrUlI/AAAAAAAAFXo/eTAOIhczZqU/s1600/bargraphconfig.png" height="338" width="640" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: left;">Click save and continue to add any other text and widgets as required. A simple dashboard showing daily consumption and the current power could look like the screenshot below and could be repeated adding a graph for each channel, heatpump, solarpv and house consumption.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-adMy8oRQCqs/U-IwqgFm4VI/AAAAAAAAFXs/pH0NkxKeIgc/s1600/simpledashboard.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-adMy8oRQCqs/U-IwqgFm4VI/AAAAAAAAFXs/pH0NkxKeIgc/s1600/simpledashboard.png" height="300" width="640" /></a></div>
      <b>To engage in discussion regarding this post, please post on our <a href="http://community.openenergymonitor.org">Community Forum</a></b>.
    <br>
</article>



        </div>

        
        <aside id="sidebar" class="grid__item one-third lap-one-whole palm-one-whole">
          <div class="grid">

 
 <section id="recent-posts" class="aside-module grid__item one-whole lap-one-half">
  <h1 class="title delta">Recent Posts</h1>
  <ul class="divided">
    
      
        <li class="post">
          <a href="/2016/05/emonpi-raspberrypi3/">emonPi / emonBase Raspberry Pi 3</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/emoncms-qr/">Emoncms android App QR Code Scanner Setup</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/website-changes/">New Forum, Blog and User Guide Website</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/05/Part3-Aggregated-supply-and-demand/">Part 3: Aggregated supply and demand across multiple households</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Part2-Exploring-carbon-intensity/">Part 2: Exploring carbon intensity and renewable energy matching</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Understand-CO2-intensity-grid-electricity/">Part 1: Attempting to measure and understand the CO2 intensity of grid electricity</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Git-Sub-Modules/">GitHub Submodules</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/04/Home-Assistant/">Home Assistant and emonPi</a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/03/raspberry-pi-3/">Raspberry Pi 3 </a>
        </li>
      
    
      
        <li class="post">
          <a href="/2016/02/outdoor-temperature-data-from-weather/">Outdoor Temperature Data from Weather Underground to Emoncms & MQTT</a>
        </li>
      
    
  </ul>
</section>
  
  
</div>
        </aside>
        
      </div>
    </div>

    <footer>
      <div class="grid-wrapper">
  <div class="grid">
    <div class="grid__item">
      <div class="copyright">
  <a rel="me" href='https://twitter.com/openenergymon'><i class="icon-twitter"></i></a>
  <a rel="me" href='https://github.com/openenergymonitor'><i class="icon-github"></i></a>
  <a rel="me" href='https://blog.openenergymonitor.org/feed.xml'><i class="icon-rss"></i></a>

  <div class="credit">
    Website powered by <a href='http://jekyllrb.com/'>Jekyll</a> and the <a href='https://github.com/coogie/oscailte'>Oscalite theme</a>.<br />
    Hosted by <a href='https://pages.github.com/'>GitHub</a> and served by <a href='https://cloudflare.com'>CloudFlare</a>.
  </div>
</div>
    </div>
  </div>
</div>
    </footer>

    <!--[if lt IE 7]>
      <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

    <script>
  var _gaq=[['_setAccount','UA-10321170-4'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
<script>
  var disqus_shortname = 'openenergymonitor';
  
    
    var disqus_script = 'count.js';
  
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


<script>
  $(document).ready(function(){
    if (!window.jXHR){
      var jxhr = document.createElement('script');
      jxhr.type = 'text/javascript';
      jxhr.src = '/javascripts/libs/jXHR.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jxhr, s);
    }

    github.showRepos({
      user: 'openenergymonitor',
      count: 5,
      skip_forks: true,
      target: '#gh_repos'
    });
  });
</script>
<script src="/javascripts/github.js"></script>

  </body>
</html>